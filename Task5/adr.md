# ADR. Эволюция в SaaS-платформу

### **Задача 1. Проектирование мультитенантности**

**Выбранная стратегия изоляции:** Изоляция на уровне схем (Schema-based Multi-tenancy).

**Сравнение вариантов:**
1.  **Отдельная БД для каждого клиента (Database per Tenant)**:
    *   *Плюсы*: Максимальная изоляция, безопасность, возможность восстановления бэкапа отдельного клиента.
    *   *Минусы*: Дорого (ресурсы), сложно управлять миграциями (N баз данных).
    *   *Диаграмма*:
    ![C2 Database per Tenant](./c2_isolation_db_per_tenant.puml)

2.  **Общая схема (Shared Database / Discriminator)**:
    *   *Плюсы*: Дешево, просто.
    *   *Минусы*: Высокий риск утечки данных (ошибка в WHERE), сложность разделения нагрузки.
    *   *Диаграмма*:
    ![C2 Shared Database](./c2_isolation_shared.puml)

3.  **Отдельная схема (Schema per Tenant)**:
    *   *Плюсы*: Баланс между стоимостью и безопасностью. В Postgres схемы работают эффективно. Данные логически разделены.
    *   *Минусы*: Требует аккуратного управления соединениями (переключение `search_path`).
    *   *Диаграмма (в составе общей архитектуры)*:
    ![C2 Schema per Tenant](./c2_saas.puml)

**Решение:** Используем **Schema per Tenant**. Для каждого нового клиента создается своя схема в PostgreSQL. Сервис `Tenant Manager` управляет миграциями и созданием схем.

### **Задача 2. Биллинг и Монетизация**

Добавлен сервис `Billing Service`.
**Функции:**
*   Управление подписками (Start, Pro, Enterprise).
*   Учет метрик (количество подключенных камер, объем хранилища).
*   Выставление счетов.

**Интеграция с платежными системами:**
Выбрана интеграция с **ЮKassa** (для РФ).
1.  Клиент выбирает тариф в Web-портале.
2.  `Billing Service` создает платеж в API ЮKassa.
3.  Клиент перенаправляется на форму оплаты.
4.  ЮKassa присылает Webhook об успехе.
5.  `Billing Service` активирует подписку через `Tenant Manager`.

### **Задача 3. Интеграция с клиентами**

Разработан **Public API**.
**Scope функционала:**
*   Получение списка ферм и устройств.
*   Получение исторических данных телеметрии.
*   Получение списка инцидентов (алертов).
*   Настройка Webhooks для уведомлений в реальном времени.

**Документация:**
Предоставляется через **Dev Portal** (на базе Swagger UI), доступный после авторизации.

**Пример интеграции:**
![C2 Integration](./c2_integration.puml)

### **Задача 4. Финальная архитектура To-Be**

Финальная архитектура представляет собой гибридное облако, где "мозги" (Edge) находятся у клиента, а управление, аналитика и биллинг — в нашем SaaS-облаке. Это позволяет масштабироваться, не перегружая каналы связи видеопотоками, при этом предоставляя клиентам удобный централизованный интерфейс.

**Контекстная диаграмма (SaaS C1):**
![C1 SaaS](./c1_saas.puml)

**Контейнерная диаграмма (SaaS C2):**
![C2 SaaS](./c2_saas.puml)
