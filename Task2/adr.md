# ADR. Проработка высокоуровневой архитектуры (Контейнеры)

### **Ограниченные контексты (Bounded Contexts)**

Для проектирования микросервисов были выделены следующие контексты:
1.  **Контекст Мониторинга (Monitoring Context)**: Отвечает за сбор данных с камер и датчиков, детекцию событий (драка, болезнь) и первичную обработку.
2.  **Контекст Управления Устройствами (Device Control Context)**: Отвечает за отправку команд на исполнительные устройства (кормушки, поилки, вентиляция).
3.  **Контекст Учета (Inventory & Health Context)**: Ведет реестр животных, историю болезней, расход кормов.
4.  **Контекст Уведомлений (Notification Context)**: Отвечает за доставку алертов операторам.

### **Основное решение (Гибридное)**

**Диаграмма:**
![C2 Main](./c2_main.puml)

**Ключевые технологии:**
*   **Backend**: Go (для Edge-сервисов из-за низкого потребления ресурсов) и Java/Spring (для облака).
*   **Video**: Python (стандарт де-факто для ML).
*   **Message Broker**: RabbitMQ.
    *   *Преимущества*: Надежная доставка сообщений, поддержка MQTT плагина для IoT, возможность Federation для синхронизации Edge-Cloud.
    *   *Компромисс*: Kafka была бы лучше для потоковой аналитики, но RabbitMQ проще в эксплуатации на Edge-сервере.
*   **Database**: PostgreSQL.
    *   *Преимущества*: Надежность, популярность.
*   **API**: REST (HTTP/JSON) для взаимодействия UI, gRPC для межсервисного общения (производительность).

**Синхронизация:**
При отсутствии связи `Sync Service` накапливает сообщения в локальной очереди RabbitMQ. При восстановлении связи данные передаются батчами.

### **Альтернативное решение (Cloud Native)**

**Диаграмма:**
![C2 Alt](./c2_alt.puml)

**Отличия:**
*   Отсутствие сложной логики на ферме.
*   Использование Kafka для обработки большого потока видеоданных в облаке.
*   Единая база данных в облаке (упрощает консистентность, но создает единую точку отказа при потере связи).

### **Риски и Компромиссы**

| Решение | Риск | Комментарий |
| :--- | :--- | :--- |
| **Гибрид** | Сложность обновления ПО на фермах | Требуется надежный механизм CI/CD для доставки контейнеров на Edge |
| **Гибрид** | Рассинхронизация данных | Возможны конфликты версий, если данные менялись и в облаке, и на ферме одновременно |
| **Cloud** | Задержка видео | Передача видео через интернет добавит секунды задержки, риск не уложиться в 5 сек SLA |
| **Cloud** | Стоимость трафика | Постоянная передача HD-видео с десятков камер будет стоить дорого |
